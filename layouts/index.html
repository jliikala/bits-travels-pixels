{{ define "main" }}
<div class="posts h-feed">
  <div class="post-list" role="main">
      {{ $paginator := .Paginate (where .Site.Pages.ByDate.Reverse "Type" "post") }}
      {{ range where $paginator.Pages "Title" "!=" "" }}
      <div class="post-preview h-entry {{ range .Params.categories }} {{ . | urlize | lower }}{{ end }}">
        <header class="post-header">
          <a href="{{ .Permalink }}" class="post-date u-url">
            <time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "January 2, 2006" }}</time>
          </a>
          <h2 class="post-title p-name"><a href="{{ .Permalink }}">{{ .Title }}</a></h2>
        </header>
        {{ if in .RawContent "<!--more-->" }}
          <div class="p-summary">
            {{ $splitContents := split .RawContent "<!--more-->" }}
            {{ $summary := index $splitContents 0 }}
            {{ $summary := replaceRE "\\[\\^.*?\\]" "" $summary }}
            {{ $summary := replaceRE "\\n\\[\\^.*?\\]:.*" "" $summary }}
            <p>{{ $summary | markdownify }}</p>
            <div class="read-more">
              <a href="{{ .Permalink }}">
                Continue reading →
              </a>
            </div>
          </div>
        {{ else }}
          <div class="e-content with-title">
            {{ .Content }}
          </div>
        {{ end }}

        <!-- Comment count container -->
        <div class="comment-count" id="comment-count-{{ .File.Path | urlize }}"></div>

        <!-- Script to fetch comment count -->
        <script>
					document.addEventListener("DOMContentLoaded", function() {
						console.log("Script loaded");
						console.log("Fetching URL: https://micro.blog/webmention?target=" + encodeURIComponent("{{ .Permalink }}"));
						const targetURL = encodeURIComponent("{{ .Permalink }}");
						fetch(`https://micro.blog/webmention?target=${targetURL}`)
							.then(response => {
								if (response.ok) return response.json();
								throw new Error("Failed to fetch webmentions");
							})
							.then(data => {
								console.log("Webmention data:", data);
								const replyCount = Array.isArray(data.items) ? data.items.length : 0;
								console.log("Reply count:", replyCount);
								const sanitizedId = "comment-count-{{ .Permalink | urlize | replace '.' '-' | replace '/' '-' }}";
								console.log("Sanitized ID:", sanitizedId);
								const commentContainer = document.getElementById(sanitizedId);
								if (commentContainer) {
									if (replyCount === 1) {
										commentContainer.innerHTML = `<p>1 reply to "{{ .Title }}"</p>`;
									} else if (replyCount > 1) {
										commentContainer.innerHTML = `<p>${replyCount} replies to "{{ .Title }}"</p>`;
									} else {
										commentContainer.innerHTML = `<p>No replies yet</p>`;
									}
								} else {
									console.error("Comment container not found for ID:", sanitizedId);
								}
							})
							.catch(error => console.error("Error fetching webmentions:", error));
					});
				</script>
      </div>
      {{ end }}
  </div>
  {{ if or $paginator.HasPrev $paginator.HasNext }}
  <div class="post-nav">
    {{ if $paginator.HasPrev }}
    <span class="prev">
      <a href="{{ $paginator.Prev.URL }}" title="Previous Page"><span class="arrow">← Newer Posts</span></a>
    </span>
    {{ end }}
    {{ if $paginator.HasNext }}
    <span class="next">
      <a href="{{ $paginator.Next.URL }}"><span class="arrow">Older Posts →</span></a>
    </span>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ end }}
